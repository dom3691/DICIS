@page "/admin"
@inject HttpClient Http
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<PageTitle>Admin Dashboard - DICIS</PageTitle>

<div class="container">
    <div style="margin-bottom: 32px;">
        <h1 style="margin-bottom: 8px;">Admin Dashboard</h1>
        <p class="small-text" style="color: var(--color-text-secondary);">
            Monitor system performance, analytics, and manage applications
        </p>
    </div>
    
    @if (isLoading)
    {
        <div class="text-center" style="padding: 64px;">
            <div class="spinner-border" style="width: 48px; height: 48px; border-width: 4px;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (analytics != null)
    {
        @if (analytics.Alerts.Any())
        {
            <div class="alert alert-warning" style="margin-bottom: 24px;">
                <h5 style="margin-bottom: 12px;">
                    <i class="bi bi-exclamation-triangle-fill" style="margin-right: 8px;"></i>
                    SLA Alerts
                </h5>
                <ul style="margin: 0; padding-left: 20px;">
                    @foreach (var alert in analytics.Alerts)
                    {
                        <li>@alert</li>
                    }
                </ul>
            </div>
        }

        <!-- Key Metrics Cards -->
        <div class="row" style="margin-bottom: 32px;">
            <div class="col-md-3">
                <div class="card" style="border-left: 4px solid var(--color-primary);">
                    <div style="padding: 20px;">
                        <div class="caption" style="color: var(--color-text-secondary); margin-bottom: 8px;">Total Applications</div>
                        <h2 style="margin: 0; color: var(--color-primary);">@analytics.TotalApplications</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card" style="border-left: 4px solid var(--color-success);">
                    <div style="padding: 20px;">
                        <div class="caption" style="color: var(--color-text-secondary); margin-bottom: 8px;">Approved</div>
                        <h2 style="margin: 0; color: var(--color-success);">@analytics.ApprovedApplications</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card" style="border-left: 4px solid var(--color-warning);">
                    <div style="padding: 20px;">
                        <div class="caption" style="color: var(--color-text-secondary); margin-bottom: 8px;">Pending</div>
                        <h2 style="margin: 0; color: var(--color-warning);">@analytics.PendingApplications</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card" style="border-left: 4px solid #2563EB;">
                    <div style="padding: 20px;">
                        <div class="caption" style="color: var(--color-text-secondary); margin-bottom: 8px;">Approval Rate</div>
                        <h2 style="margin: 0; color: #2563EB;">@analytics.ApprovalRate.ToString("F1")%</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row" style="margin-bottom: 32px;">
            <div class="col-md-6">
                <div class="card" style="border: none; box-shadow: var(--shadow-md);">
                    <div class="card-header" style="background: white; border-bottom: 1px solid var(--color-border);">
                        <h3 style="margin: 0;">Key Metrics</h3>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border);">
                            <div class="caption" style="color: var(--color-text-secondary);">Average Verification Time</div>
                            <div style="display: flex; align-items: baseline; margin-top: 4px;">
                                <h2 style="margin: 0; color: var(--color-primary);">@analytics.AverageVerificationTimeSeconds.ToString("F2")</h2>
                                <span class="small-text" style="color: var(--color-text-secondary); margin-left: 8px;">seconds</span>
                            </div>
                            @if (analytics.SLA.VerificationTimeExceeded)
                            {
                                <span class="badge badge-warning" style="margin-top: 8px;">Exceeds SLA (60s)</span>
                            }
                        </div>
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border);">
                            <div class="caption" style="color: var(--color-text-secondary);">Average Certificate Generation Time</div>
                            <div style="display: flex; align-items: baseline; margin-top: 4px;">
                                <h2 style="margin: 0; color: var(--color-primary);">@analytics.AverageCertificateGenerationTimeSeconds.ToString("F2")</h2>
                                <span class="small-text" style="color: var(--color-text-secondary); margin-left: 8px;">seconds</span>
                            </div>
                            @if (analytics.SLA.CertificateGenerationTimeExceeded)
                            {
                                <span class="badge badge-warning" style="margin-top: 8px;">Exceeds SLA (10s)</span>
                            }
                        </div>
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border);">
                            <div class="caption" style="color: var(--color-text-secondary);">Fraud Reports</div>
                            <h2 style="margin: 0; color: var(--color-error); margin-top: 4px;">@analytics.FraudReportsCount</h2>
                        </div>
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border);">
                            <div class="caption" style="color: var(--color-text-secondary);">Revoked Certificates</div>
                            <h2 style="margin: 0; color: var(--color-error); margin-top: 4px;">@analytics.RevokedCertificatesCount</h2>
                        </div>
                        <div>
                            <div class="caption" style="color: var(--color-text-secondary);">SLA Compliance Rate</div>
                            <div style="display: flex; align-items: baseline; margin-top: 4px;">
                                <h2 style="margin: 0; color: var(--color-success);">@analytics.SLA.SLAComplianceRate.ToString("F1")</h2>
                                <span class="small-text" style="color: var(--color-text-secondary); margin-left: 8px;">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card" style="border: none; box-shadow: var(--shadow-md);">
                    <div class="card-header" style="background: white; border-bottom: 1px solid var(--color-border);">
                        <h3 style="margin: 0;">Applications by State</h3>
                    </div>
                    <div class="card-body">
                        @if (analytics.ApplicationsByState.Any())
                        {
                            @foreach (var state in analytics.ApplicationsByState)
                            {
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--color-border);">
                                    <span style="font-weight: 500;">@state.Key</span>
                                    <span class="badge" style="background: var(--color-bg-primary); color: var(--color-text-primary);">@state.Value</span>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="small-text" style="color: var(--color-text-secondary); text-align: center; padding: 32px;">
                                No data available
                            </p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Applications Chart -->
        <div class="card" style="border: none; box-shadow: var(--shadow-md);">
            <div class="card-header" style="background: white; border-bottom: 1px solid var(--color-border);">
                <h3 style="margin: 0;">Daily Applications</h3>
            </div>
            <div class="card-body">
                @if (analytics.ApplicationsByDay.Any())
                {
                    <div style="display: flex; align-items: flex-end; gap: 8px; height: 200px; padding: 20px 0;">
                        @foreach (var day in analytics.ApplicationsByDay)
                        {
                            var maxValue = analytics.ApplicationsByDay.Values.Max();
                            var height = maxValue > 0 ? (day.Value * 100.0 / maxValue) : 0;
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                <div style="width: 100%; background: var(--color-primary); border-radius: 4px 4px 0 0; min-height: 20px; height: @(height)%; margin-bottom: 8px;">
                                </div>
                                <span class="caption" style="writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);">
                                    @day.Key.Substring(5)
                                </span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="small-text" style="color: var(--color-text-secondary); text-align: center; padding: 32px;">
                        No data available
                    </p>
                }
            </div>
        </div>
    }
</div>

@code {
    private Core.DTOs.AnalyticsResponse? analytics;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var isAuth = await AuthService.IsAuthenticatedAsync();
        if (!isAuth)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = 
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            analytics = await Http.GetFromJsonAsync<Core.DTOs.AnalyticsResponse>("api/admin/analytics");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
