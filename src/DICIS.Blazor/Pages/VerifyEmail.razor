@page "/verify-email"
@inject ProfileService ProfileService
@inject NavigationManager Navigation

<PageTitle>Verify Email - DICIS</PageTitle>

<div class="container" style="max-width: 600px; margin: 64px auto;">
    <div class="card" style="border: none; box-shadow: var(--shadow-lg);">
        <div class="card-header" style="background: linear-gradient(135deg, #0B6B3A 0%, #0A5A2F 100%); color: white; border: none; border-radius: var(--radius-md) var(--radius-md) 0 0;">
            <h2 style="margin: 0; color: white;">
                <i class="bi bi-envelope-check" style="margin-right: 8px;"></i>
                Verify Email Address
            </h2>
        </div>
        <div class="card-body" style="padding: 40px;">
            @if (isVerifying)
            {
                <div class="text-center">
                    <div class="spinner-border" style="width: 48px; height: 48px; border-width: 4px; color: var(--color-primary);" role="status">
                        <span class="visually-hidden">Verifying...</span>
                    </div>
                    <p style="margin-top: 16px; color: var(--color-text-secondary);">Verifying your email...</p>
                </div>
            }
            else if (isVerified)
            {
                <div class="text-center">
                    <div style="width: 80px; height: 80px; background: #D1FAE5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                        <i class="bi bi-check-circle-fill" style="font-size: 48px; color: var(--color-success);"></i>
                    </div>
                    <h3 style="color: var(--color-success); margin-bottom: 16px;">Email Verified Successfully!</h3>
                    <p style="color: var(--color-text-secondary); margin-bottom: 32px;">
                        Your email address has been verified. You can now access all services.
                    </p>
                    <a href="/" class="btn btn-primary">
                        <i class="bi bi-house" style="margin-right: 8px;"></i>
                        Go to Dashboard
                    </a>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill" style="margin-right: 8px;"></i>
                    @errorMessage
                </div>
                <div style="text-align: center; margin-top: 24px;">
                    <a href="/" class="btn btn-outline">Go to Home</a>
                </div>
            }
            else
            {
                <div class="text-center">
                    <p style="color: var(--color-text-secondary);">
                        Please wait while we verify your email address...
                    </p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool isVerifying = true;
    private bool isVerified = false;
    private string errorMessage = string.Empty;

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Token))
        {
            errorMessage = "Invalid verification link. Please check your email and try again.";
            isVerifying = false;
            return;
        }

        try
        {
            var result = await ProfileService.VerifyEmailAsync(Token);
            if (result)
            {
                isVerified = true;
            }
            else
            {
                errorMessage = "Invalid or expired verification token. Please request a new verification email.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error verifying email: {ex.Message}";
        }
        finally
        {
            isVerifying = false;
        }
    }
}
