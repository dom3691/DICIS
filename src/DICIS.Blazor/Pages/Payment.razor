@page "/services/payment/{ServiceRequestId:int}"
@inject ServiceRequestService ServiceRequestService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Payment - DICIS</PageTitle>

<div class="container" style="max-width: 600px; margin: 64px auto;">
    <div class="card" style="border: none; box-shadow: var(--shadow-lg);">
        <div class="card-header" style="background: linear-gradient(135deg, #0B6B3A 0%, #0A5A2F 100%); color: white; border: none; border-radius: var(--radius-md) var(--radius-md) 0 0;">
            <h2 style="margin: 0; color: white;">
                <i class="bi bi-credit-card" style="margin-right: 8px;"></i>
                Complete Payment
            </h2>
        </div>
        <div class="card-body" style="padding: 40px;">
            @if (isLoading)
            {
                <div class="text-center" style="padding: 64px;">
                    <div class="spinner-border" style="width: 48px; height: 48px; border-width: 4px;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (serviceRequest != null)
            {
                @if (serviceRequest.PaymentStatus == Core.Entities.PaymentStatus.Completed)
                {
                    <div class="text-center">
                        <div style="width: 80px; height: 80px; background: #D1FAE5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                            <i class="bi bi-check-circle-fill" style="font-size: 48px; color: var(--color-success);"></i>
                        </div>
                        <h3 style="color: var(--color-success); margin-bottom: 16px;">Payment Successful!</h3>
                        <p style="color: var(--color-text-secondary); margin-bottom: 8px;">
                            Payment Reference: <strong>@serviceRequest.PaymentReference</strong>
                        </p>
                        <p style="color: var(--color-text-secondary); margin-bottom: 32px;">
                            Your service request is being processed.
                        </p>
                        <a href="/services/my-requests" class="btn btn-primary">
                            <i class="bi bi-list" style="margin-right: 8px;"></i>
                            View My Requests
                        </a>
                    </div>
                }
                else
                {
                    <div style="margin-bottom: 32px;">
                        <div style="background: var(--color-bg-primary); padding: 24px; border-radius: var(--radius-md); margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <span class="caption" style="color: var(--color-text-secondary);">Service Type</span>
                                <span style="font-weight: 600;">@serviceRequest.ServiceType</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="caption" style="color: var(--color-text-secondary);">Amount</span>
                                <h2 style="margin: 0; color: var(--color-primary);">₦@(serviceRequest.Amount.ToString("N2"))</h2>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Payment Method *</label>
                            <InputSelect class="form-select" @bind-Value="paymentMethod">
                                <option value="">Select Payment Method</option>
                                <option value="Card">Debit/Credit Card</option>
                                <option value="BankTransfer">Bank Transfer</option>
                                <option value="USSD">USSD</option>
                            </InputSelect>
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill" style="margin-right: 8px;"></i>
                                @errorMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle-fill" style="margin-right: 8px;"></i>
                                @successMessage
                            </div>
                        }

                        <div style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 32px;">
                            <a href="/services" class="btn btn-outline">Cancel</a>
                            <button class="btn btn-primary" @onclick="ProcessPayment" disabled="@isProcessing || string.IsNullOrEmpty(paymentMethod)">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-credit-card" style="margin-right: 8px;"></i>
                                Pay ₦@(serviceRequest.Amount.ToString("N2"))
                            </button>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-danger">
                    Service request not found
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int ServiceRequestId { get; set; }

    private ServiceRequestDTO? serviceRequest;
    private string paymentMethod = string.Empty;
    private bool isLoading = true;
    private bool isProcessing = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var isAuth = await AuthService.IsAuthenticatedAsync();
        if (!isAuth)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadServiceRequest();
    }

    private async Task LoadServiceRequest()
    {
        try
        {
            serviceRequest = await ServiceRequestService.GetServiceRequestAsync(ServiceRequestId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading service request: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ProcessPayment()
    {
        if (string.IsNullOrEmpty(paymentMethod))
        {
            errorMessage = "Please select a payment method";
            return;
        }

        isProcessing = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var paymentRequest = new PaymentRequest
            {
                ServiceRequestId = ServiceRequestId,
                PaymentMethod = paymentMethod
            };

            var result = await ServiceRequestService.ProcessPaymentAsync(ServiceRequestId, paymentRequest);

            if (result.IsSuccessful)
            {
                successMessage = "Payment processed successfully!";
                await Task.Delay(1000);
                await LoadServiceRequest(); // Reload to show updated status
            }
            else
            {
                errorMessage = result.Message ?? "Payment failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
}
